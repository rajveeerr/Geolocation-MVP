# Bounty Deal QR Code Implementation Guide

## üìã Overview

QR codes for **Bounty Deals** are used to verify that customers actually brought friends when redeeming the deal. This prevents fraud and ensures accurate bounty reward tracking.

## üîç How It Works

### Backend Process

1. **QR Code Generation** (Backend):
   - When a bounty deal is created, the backend automatically generates a QR code
   - Format: `BOUNTY:dealId:merchantId:timestamp:signature`
   - Stored in `deal.bountyQRCode` field
   - Includes cryptographic signature to prevent tampering

2. **QR Code Verification** (Backend):
   - When customer redeems deal, they scan the QR code
   - Backend verifies:
     - Signature matches
     - QR code is not expired (30 days max)
     - QR code matches the deal being redeemed
   - If valid, bounty rewards are calculated and credited

### Frontend Implementation

#### 1. **BountyQRCodeDisplay Component**
Location: `web/src/components/merchant/create-deal/BountyQRCodeDisplay.tsx`

**Features:**
- Displays QR code image (generated via QR Server API)
- Shows instructions on how to use it
- Download button to save QR code as PNG
- Copy QR code data button
- Responsive sizing (sm, md, lg)

**Usage:**
```tsx
<BountyQRCodeDisplay
  qrCodeData="BOUNTY:123:456:1699999999:abc12345"
  dealId={123}
  merchantName="My Restaurant"
  showInfo={true}
  size="md"
/>
```

#### 2. **Deal Review Step**
Location: `web/src/components/merchant/create-deal/DealReviewStep.tsx`

- Shows QR code preview before publishing
- After deal creation, backend response includes `bountyQRCode`
- Displays success message mentioning QR code generation

#### 3. **Deal Detail Page**
Location: `web/src/pages/EnhancedDealDetailPage.tsx`

- For bounty deals, displays the verification QR code
- Shows different message: "Scan this QR code when redeeming to verify you brought friends"
- Warning: "‚ö†Ô∏è Required for bounty rewards"
- Customers can download the QR code

#### 4. **QR Code Section Component**
Updated `QRCodeSection` to:
- Detect if deal is a bounty deal
- Use `bountyQRCode` data if available
- Fall back to deal link QR code for non-bounty deals
- Show appropriate messaging

## üì± User Flow

### For Merchants:

1. **Create Bounty Deal:**
   - Go to deal creation
   - Select "Bounty Deal"
   - Set reward amount and minimum referrals
   - Complete deal creation
   - **QR code is auto-generated by backend**

2. **View QR Code:**
   - After publishing, QR code is available in:
     - Deal detail page (for printing/displaying)
     - Merchant dashboard (if implemented)
   - Download QR code to print and display at location

3. **Display at Location:**
   - Print QR code
   - Display at checkout counter
   - Customers scan when redeeming

### For Customers:

1. **View Deal:**
   - See bounty deal on app
   - QR code visible in deal detail page

2. **Redeem Deal:**
   - Bring required number of friends
   - Show deal to merchant
   - **Merchant scans QR code** (or customer scans if self-service)
   - System verifies QR code
   - Bounty rewards are credited

## üîß Technical Details

### QR Code Data Format

```
BOUNTY:dealId:merchantId:timestamp:signature
```

Example:
```
BOUNTY:123:456:1699999999:abc12345
```

### Backend Functions

**Generate QR Code:**
```typescript
generateBountyQRCode(dealId: number, merchantId: number): string
```

**Verify QR Code:**
```typescript
verifyBountyQRCode(qrCodeData: string): { dealId: number; merchantId: number } | null
```

### API Response

When creating a bounty deal, response includes:
```json
{
  "success": true,
  "deal": {
    "id": 123,
    "bountyQRCode": "BOUNTY:123:456:1699999999:abc12345",
    ...
  },
  "bounty": {
    "qrCode": "BOUNTY:123:456:1699999999:abc12345"
  }
}
```

### Frontend Type Updates

Added to `DetailedDeal` interface:
```typescript
bountyQRCode?: string | null;
```

## üé® UI Components

### BountyQRCodeDisplay Props

```typescript
interface BountyQRCodeDisplayProps {
  qrCodeData?: string | null;  // QR code data from backend
  dealId?: number;              // Deal ID for placeholder
  merchantName?: string;         // Merchant name for download filename
  showInfo?: boolean;            // Show usage instructions
  size?: 'sm' | 'md' | 'lg';    // QR code size
}
```

### QR Code Generation

Uses **QR Server API** (free service):
```
https://api.qrserver.com/v1/create-qr-code/?size=200x200&data={encoded_data}
```

## ‚úÖ Testing Checklist

- [ ] Create a bounty deal
- [ ] Verify QR code appears in review step (placeholder)
- [ ] Publish deal
- [ ] Verify QR code is in API response
- [ ] View deal detail page
- [ ] Verify QR code displays correctly
- [ ] Download QR code (should save as PNG)
- [ ] Copy QR code data (should copy to clipboard)
- [ ] Verify QR code data format is correct
- [ ] Test with different QR code sizes
- [ ] Test on mobile devices
- [ ] Verify QR code works for redemption (backend)

## üêõ Known Issues / Future Improvements

1. **QR Code Display After Creation:**
   - Currently, QR code is shown in review step as placeholder
   - Could add a success modal showing QR code after publishing
   - Could add QR code to merchant dashboard

2. **QR Code Scanning:**
   - Currently, merchant needs to manually scan
   - Could add merchant app with QR scanner
   - Could add self-service redemption with QR scan

3. **QR Code Expiration:**
   - QR codes expire after 30 days
   - Could add expiration warning in UI
   - Could add QR code regeneration feature

4. **QR Code Analytics:**
   - Track QR code scans
   - Show redemption statistics
   - Monitor fraud attempts

## üìö Related Files

- `backend/src/lib/dealUtils.ts` - QR code generation/verification
- `backend/src/routes/merchant.routes.ts` - Deal creation with QR code
- `backend/src/routes/deals.public.routes.ts` - Deal redemption with QR verification
- `web/src/components/merchant/create-deal/BountyQRCodeDisplay.tsx` - QR code display component
- `web/src/components/merchant/create-deal/DealReviewStep.tsx` - Review step with QR preview
- `web/src/pages/EnhancedDealDetailPage.tsx` - Deal detail with QR code
- `web/src/hooks/useDealDetail.ts` - Deal detail type definitions

## üöÄ Quick Start

1. **Create a Bounty Deal:**
   ```
   Navigate to: /merchant/deals/create
   Select: "Bounty Deal"
   Set: Reward amount ($5) and minimum friends (2)
   Complete: All steps and publish
   ```

2. **View QR Code:**
   ```
   After publishing, navigate to deal detail page
   QR code appears in right sidebar
   Click "Download" to save
   ```

3. **Use QR Code:**
   ```
   Print QR code
   Display at merchant location
   Customers scan when redeeming
   System verifies and credits rewards
   ```

---

**Note:** QR codes are automatically generated by the backend when creating bounty deals. No manual QR code creation is needed on the frontend.

